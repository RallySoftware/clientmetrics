(function(){function a(a,b,c){var d=b&&c||0,e=0;for(b=b||[],a.toLowerCase().replace(/[0-9a-f]{2}/g,function(a){16>e&&(b[d+e++]=m[a])});16>e;)b[d+e++]=0;return b}function b(a,b){var c=b||0,d=l;return d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]}function c(a,c,d){var e=c&&d||0,f=c||[];a=a||{};var g=null!=a.clockseq?a.clockseq:q,h=null!=a.msecs?a.msecs:(new Date).getTime(),i=null!=a.nsecs?a.nsecs:s+1,j=h-r+(i-s)/1e4;if(0>j&&null==a.clockseq&&(g=g+1&16383),(0>j||h>r)&&null==a.nsecs&&(i=0),i>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");r=h,s=i,q=g,h+=122192928e5;var k=(1e4*(268435455&h)+i)%4294967296;f[e++]=k>>>24&255,f[e++]=k>>>16&255,f[e++]=k>>>8&255,f[e++]=255&k;var l=h/4294967296*1e4&268435455;f[e++]=l>>>8&255,f[e++]=255&l,f[e++]=l>>>24&15|16,f[e++]=l>>>16&255,f[e++]=g>>>8|128,f[e++]=255&g;for(var m=a.node||p,n=0;6>n;n++)f[e+n]=m[n];return c?c:b(f)}function d(a,c,d){var f=c&&d||0;"string"==typeof a&&(c="binary"==a?new k(16):null,a=null),a=a||{};var g=a.random||(a.rng||e)();if(g[6]=15&g[6]|64,g[8]=63&g[8]|128,c)for(var h=0;16>h;h++)c[f+h]=g[h];return c||b(g)}var e,f=this;if("function"==typeof f.require)try{var g=f.require("crypto").randomBytes;e=g&&function(){return g(16)}}catch(h){}if(!e&&f.crypto&&crypto.getRandomValues){var i=new Uint8Array(16);e=function(){return crypto.getRandomValues(i),i}}if(!e){var j=new Array(16);e=function(){for(var a,b=0;16>b;b++)0===(3&b)&&(a=4294967296*Math.random()),j[b]=a>>>((3&b)<<3)&255;return j}}for(var k="function"==typeof f.Buffer?f.Buffer:Array,l=[],m={},n=0;256>n;n++)l[n]=(n+256).toString(16).substr(1),m[l[n]]=n;var o=e(),p=[1|o[0],o[1],o[2],o[3],o[4],o[5]],q=16383&(o[6]<<8|o[7]),r=0,s=0,t=d;if(t.v1=c,t.v4=d,t.parse=a,t.unparse=b,t.BufferClass=k,"undefined"!=typeof module&&module.exports)module.exports=t;else if("function"==typeof define&&define.amd)define(function(){return t});else{var u=f.uuid;t.noConflict=function(){return f.uuid=u,t},f.uuid=t}}).call(this),function(a,b){"object"==typeof exports?module.exports=b(require("underscore")):"function"==typeof define&&define.amd?define(["underscore"],b):a.RallyMetrics=b(a._)}(this,function(a){var b=function(b){return{underscore:a}[b]};return(b=function c(a,d,e){function f(h,i){if(!d[h]){if(!a[h]){var j="function"==typeof b&&b;if(!i&&j)return j(h,!0);if(g)return g(h,!0);throw new Error("Cannot find module '"+h+"'")}var k=d[h]={exports:{}};a[h][0].call(k.exports,function(b){var c=a[h][1][b];return f(c?c:b)},k,k.exports,c,a,d,e)}return d[h].exports}for(var g="function"==typeof b&&b,h=0;h<e.length;h++)f(e[h]);return f}({1:[function(a,b,c){var d=a("underscore"),e=a("./corsBatchSender"),f=window.uuid,g=25,h="__clientMetricsCurrentEventId__",i="__clientMetricsID__",j=function(a){d.extend(this,a),this._pendingEvents=[],this._browserTabId=this._getUniqueId(),this._startingTime=(new Date).getTime(),this._sessionId=1,this._loadedComponents=[],this._errorCount=0,this.errorLimit=this.errorLimit||g,this.handlers=this.handlers||[],this.sender=this.sender||new e({keysToIgnore:["cmp","component"],beaconUrl:a.beaconUrl,disableSending:a.disableSending}),d.isFunction(this.sender.getMaxLength)&&(this.maxErrorLength=Math.floor(.9*this.sender.getMaxLength())),d.isNumber(this.flushInterval)&&(this._flushIntervalId=window.setInterval(d.bind(this.sendAllRemainingEvents,this),this.flushInterval))};j.prototype.destroy=function(){this._flushIntervalId&&window.clearInterval(this._flushIntervalId)},j.prototype.startSession=function(a,b){arguments.length<2&&(b=a),this._pendingEvents=[],b&&b.sessionStart&&(this._startingTime=b.sessionStart,delete b.sessionStart),this._sessionStartTime=this.getRelativeTime(),this.sendAllRemainingEvents(),this._defaultParams=b,this._errorCount=0,this._loadedComponents=[],this._sessionId++},j.prototype.recordAction=function(a){var b=a.component;delete a.component;var c=this._getUniqueId(),e=this.getRelativeTime(a.startTime),f=this._startEvent(d.defaults({eType:"action",cmp:b,cmpH:a.hierarchy||this._getHierarchyString(b),eDesc:a.description,cmpId:this._getComponentId(b),eId:c,tId:c,status:"Ready",cmpType:a.name||this.getComponentType(b),start:e,stop:e},a.miscData));return this._currentTraceId=c,this._finishEvent(f),c},j.prototype.recordError=function(a,b){var c;d.isObject(a)&&a.errorInfo&&(c=a,a=c.errorInfo,b=c.miscData);var e=this._currentTraceId;if(e&&this._errorCount<this.errorLimit){++this._errorCount;var f=a||"unknown error";this.maxErrorLength&&(f=f.substring(0,this.maxErrorLength));var g=this.getRelativeTime(),h=this._startEvent(d.defaults({eType:"error",error:f,eId:this._getUniqueId(),tId:e,start:g,stop:g},b));this._finishEvent(h),this.sendAllRemainingEvents()}},j.prototype.recordComponentReady=function(a){if(!d.isUndefined(this._sessionStartTime)){var b=this._currentTraceId,c=a.component,e=a.hierarchy||this._getHierarchyString(c),f=this._loadedComponents.indexOf(e)>-1;if(!f){this._loadedComponents.push(e);var g=this._startEvent(d.defaults({eType:"load",start:this._sessionStartTime,stop:this.getRelativeTime(a.stopTime),eId:this._getUniqueId(),tId:b,pId:b,cmpType:a.name||this.getComponentType(c),cmpH:e,eDesc:"component ready",componentReady:!0},a.miscData));this._finishEvent(g)}}},j.prototype.startSpan=function(a){var b=this,c=a.component,e=this._currentTraceId;if(e){var f=this.getRelativeTime(a.startTime),g=this._getUniqueId(),h=d.defaults({eType:a.type||"load",cmp:c,cmpH:a.hierarchy||this._getHierarchyString(c),eId:g,cmpType:a.name||this.getComponentType(c),tId:e,pId:a.pId||e,start:f},a.miscData);return a.description&&(h.eDesc=a.description),{data:this._startEvent(h),end:function(a){b._currentTraceId===e&&(a=a||{},a.stop=b.getRelativeTime(a.stopTime),b._shouldRecordEvent(this.data,a)&&b._finishEvent(this.data,d.extend({status:"Ready"},d.omit(a,"stopTime"))))}}}},j.prototype.beginLoad=function(a){var b=a.component,c=this._currentTraceId;if(c&&!b[h+"load"]){var e=this.getRelativeTime(a.startTime),f=this._getUniqueId();b[h+"load"]=f;var g=d.defaults({eType:"load",cmp:b,cmpH:this._getHierarchyString(b),eDesc:a.description,cmpId:this._getComponentId(b),eId:f,cmpType:this.getComponentType(b),tId:c,pId:this._findParentId(b,c),start:e},a.miscData);this._startEvent(g)}},j.prototype.endLoad=function(a){var b=a.component,c=b[h+"load"];if(c){delete b[h+"load"];var e=this._findPendingEvent(c);e&&(a.stop=this.getRelativeTime(a.stopTime),this._shouldRecordEvent(e,a)&&this._finishEvent(e,d.extend({status:"Ready"},d.omit(a,"stopTime"))))}},j.prototype.beginDataRequest=function(a,b,c){var e,f;1===arguments.length&&(e=arguments[0],a=e.requester,b=e.url,c=e.miscData);var g=this._currentTraceId;if(a&&g){var i=this._getUniqueId(),j=this._findParentId(a,g),k=this._getUniqueId();a[h+"dataRequest"+k]=i,this._startEvent(d.defaults({eType:"dataRequest",cmp:a,cmpH:this._getHierarchyString(a),url:this._getUrl(b),cmpType:this.getComponentType(a),cmpId:this._getComponentId(a),eId:i,tId:g,pId:j},c)),f={requestId:k,xhrHeaders:{"X-Trace-Id":g,"X-Parent-Id":i}}}return f},j.prototype.endDataRequest=function(a,b,c){var d;if(1===arguments.length&&(d=arguments[0],a=d.requester,b=d.xhr,c=d.requestId),a){var e=a[h+"dataRequest"+c],f=this._findPendingEvent(e);if(!f)return;var g={status:"Ready",stop:this.getRelativeTime()},i=this._getRallyRequestId(b);i&&(g.rallyRequestId=i),this._finishEvent(f,g)}},j.prototype.sendAllRemainingEvents=function(){this.sender.flush()},j.prototype.getComponentType=function(a){return this._getFromHandlers(a.singleton||a,"getComponentType")},j.prototype.getDefaultParams=function(){return this._defaultParams},j.prototype.getSessionStartTime=function(){return this._sessionStartTime},j.prototype.addHandler=function(a,b){var c=2===arguments.length?b:this.handlers.length;this.handlers.splice(c,0,a)},j.prototype._getUniqueId=function(){return f.v4()},j.prototype.getRelativeTime=function(a){return(a||(new Date).getTime())-this._startingTime},j.prototype.getUnrelativeTime=function(a){return a+this._startingTime},j.prototype._finishEvent=function(a,b){var c=d.defaults(b||{},a,this._defaultParams,this._guiTestParams);this._pendingEvents=d.without(this._pendingEvents,a),this.sender.send(c)},j.prototype._startEvent=function(a){if(a.tabId=this._browserTabId,d.isNumber(a.start)||(a.start=this.getRelativeTime()),a.bts=this.getUnrelativeTime(a.start),a.cmp){var b=this._getFromHandlers(a.cmp,"getAppName");b&&(a.appName=b)}return this._pendingEvents.push(a),a},j.prototype._getFromHandlers=function(a,b){var c=null;return d.each(this.handlers,function(d){return c=d[b](a),!c}),c},j.prototype._findParentId=function(a,b){var c=this._getHierarchy(a),e=b;return d.each(c,function(c){var f=d.findLast(this._pendingEvents,function(d){return"dataRequest"!==d.eType&&(d.cmp===c||d.cmp===a)&&d.tId===b});return f?(e=f.eId,!1):void 0},this),e},j.prototype._getComponentId=function(a){return a[i]||(a[i]=this._getUniqueId()),a[i]},j.prototype._getHierarchy=function(a){for(var b=this.getComponentType(a),c=[];b;)c.push(a),a=a.clientMetricsParent||a.ownerCt||a.owner||a.initialConfig&&a.initialConfig.owner,b=a&&this.getComponentType(a);return c},j.prototype._getHierarchyString=function(a){var b=this._getHierarchy(a);return 0===b.length?"none":d.map(b,function(a){return this.getComponentType(a)},this).join(":")},j.prototype._getUrl=function(a){if(!a)return"unknown";var b,c="webservice/",d=a.indexOf(c);if(d>-1){b=a.indexOf("?",d),0>b&&(b=a.length);var e=c.length;return a.substring(d+e,b)}return b=a.indexOf("?"),0>b?a:a.substring(0,b)},j.prototype._getRallyRequestId=function(a){var b="RallyRequestID";if(a){if(d.isString(a))return a;if(d.isObject(a.responseHeaders))return a.responseHeaders.RallyRequestID;if(d.isFunction(a.getResponseHeader))return a.getResponseHeader(b);if(d.isObject(a.getResponseHeader))return a.getResponseHeader[b];if(d.isFunction(a.headers))return a.headers(b)}},j.prototype._findPendingEvent=function(a){return d.find(this._pendingEvents,{eId:a})},j.prototype._shouldRecordEvent=function(a,b){return b.whenLongerThan&&b.stop-a.start<=b.whenLongerThan?(this._pendingEvents=d.without(this._pendingEvents,a),!1):!0},b.exports=j},{"./corsBatchSender":2}],2:[function(a,b,c){var d=a("underscore"),e=a("./util"),f=25,g=100,h=function(a){d.defaults(this,a,{_disabled:!1,keysToIgnore:[],minNumberOfEvents:f,maxNumberOfEvents:g,beaconUrl:"https://trust.f4tech.com/beacon/"}),a.disableSending&&this._disableClientMetrics(),this._eventQueue=[]};h.prototype.send=function(a){this._eventQueue.push(this._cleanEvent(a)),this._sendBatches()},h.prototype.flush=function(){this._sendBatches({flush:!0})},h.prototype.getPendingEvents=function(){return this._eventQueue},h.prototype.getMaxLength=function(){return this.maxLength},h.prototype._sendBatches=function(a){for(var b;b=this._getNextBatch(a);)this._sendBatch(b)},h.prototype._cleanEvent=function(a){return d.omit(a,this.keysToIgnore)},h.prototype._getNextBatch=function(a){var b=d.take(this._eventQueue,this.maxNumberOfEvents);return b.length&&(b.length>=this.minNumberOfEvents||a&&a.flush)?b:void 0},h.prototype._appendIndexToKeys=function(a,b){return d.transform(a,function(a,c,d){a[d+"."+b]=c})},h.prototype._sendBatch=function(a){this._disabled||this._makePOST(a),this._eventQueue=d.difference(this._eventQueue,a)},h.prototype._getUrl=function(){return this.beaconUrl},h.prototype._disableClientMetrics=function(){this._disabled=!0},h.prototype.isDisabled=function(){return this._disabled},h.prototype._allValuesAsStrings=function(a){return d.forIn(a,function(a,b,c){d.isString(a)||(c[b]=""+a)})},h.prototype._makePOST=function(a){var b=d.reduce(a,function(a,b,c){return b=this._allValuesAsStrings(b),d.extend(a,this._appendIndexToKeys(b,c))},{},this);try{var c=e.createCorsXhr("POST",this.beaconUrl);c?(c.onerror=d.bind(this._disableClientMetrics,this),setTimeout(function(){c.send(JSON.stringify(b))},0)):this._disableClientMetrics()}catch(f){this._disableClientMetrics()}},b.exports=h},{"./util":5}],RallyMetrics:[function(a,b,c){b.exports=a("sOmqIC")},{}],sOmqIC:[function(a,b,c){b.exports={Aggregator:a("./aggregator"),CorsBatchSender:a("./corsBatchSender"),Util:a("./util"),WindowErrorListener:a("./windowErrorListener")}},{"./aggregator":1,"./corsBatchSender":2,"./util":5,"./windowErrorListener":6}],5:[function(a,b,c){!function(){var c=a("underscore"),d={addEventHandler:function(a,b,c,d){a.addEventListener?a.addEventListener(b,c,d):a.attachEvent&&a.attachEvent("on"+b,c)},removeEventHandler:function(a,b,c){a.removeEventListener?a.removeEventListener(b,c):a.detachEvent&&a.detachEvent("on"+b,c)},removeFromDom:function(a){c.isFunction(a.remove)?a.remove():a.parentNode&&a.parentNode.removeChild(a)},createCorsXhr:function(a,b){var c=new XMLHttpRequest;return"withCredentials"in c?(c.open(a,b,!0),c.setRequestHeader("Content-type","application/json; charset=utf-8")):"undefined"!=typeof XDomainRequest?(c=new XDomainRequest,c.onload=function(){},c.onprogress=function(){},c.ontimeout=function(){},c.open(a,b)):c=null,c}};b.exports=d}()},{}],6:[function(a,b,c){!function(){var c=a("underscore"),d=a("./util"),e=!0,f=c.template("<%= message %>, <%= filename %>:<%= lineNumber %>"),g=c.template("onerror::<%= message %>, <%= filename %>:<%= lineNumber %>"),h=function(a,b,f){var g=c.isBoolean(b)?b:e;this.aggregator=a,this._stackLimit=null,f&&f.stackLimit&&(this._stackLimit=parseInt(f.stackLimit,10)),g?(this._originalWindowOnError=window.onerror,window.onerror=c.bind(this._windowOnError,this)):d.addEventHandler(window,"error",c.bind(this._onUnhandledError,this),!1)};c.extend(h.prototype,{_windowOnError:function(a,b,d,e,g){c.isFunction(this._originalWindowOnError)&&this._originalWindowOnError.call(window,a,b,d);var h=f({message:a||"unknown message",filename:b||"??",lineNumber:c.isNumber(d)?d:"??"}),i={};e&&(i.columnNumber=e),g&&g.stack&&(i.stack=g.stack,this._stackLimit&&(i.stack=c.take(i.stack.split("\n"),this._stackLimit).join("\n"))),this.aggregator.recordError(h,i)},_onUnhandledError:function(a){var b;b=a.browserEvent?g({message:a.browserEvent.message||"unknown message",filename:a.browserEvent.filename||"??",lineNumber:a.browserEvent.lineno||"??"}):"onerror::"+(a.message||"unknown error"),this.aggregator.recordError(b)}}),b.exports=h}()},{"./util":5}]},{},["sOmqIC"]))("RallyMetrics")});